<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/CHW.css" rel="stylesheet">
    <link href="css/ui-darkness/jquery-ui-1.10.4.custom.min.css" rel="stylesheet">
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui-1.10.4.custom.min.js"></script>
    <script src="js/jquery.validate.min.js"></script>
    <script src="js/additional-methods.min.js"></script>
    <script src="js/mchw.js"></script>

    <title>Patient Biodata</title>
</head>

<body class="col-md-10 col-md-offset-1">
<div id="pre_populate_data"></div>
<h2 class="text-center">Patient Biodata</h2>

<form id="breastcancer_form" name="breastcancer_form">

    <div class="section">
        <h3>Demographics</h3>

        <div class="form-group">
            <input class="form-control" id="patient.uuid" name="patient.uuid" type="hidden">
        </div>
        <div class="form-group">
            <label for="patient.medical_record_number">Patient ID:</label>
            <input class="form-control" id="patient.medical_record_number"
                   name="patient.medical_record_number" type="text">
        </div>
        <div class="form-group">
            <label for="patient.family_name">Family Name:</label>
            <input class="form-control" id="patient.family_name" name="patient.family_name"
                   type="text">
        </div>
        <div class="form-group">
            <label for="patient.given_name">Full Name:</label>
            <input class="form-control" id="patient.given_name" name="patient.given_name"
                   type="text">
        </div>
        <div class="form-group">
            <label for="patient.middle_name">Household Number:</label>
            <input class="form-control" id="patient.middle_name" name="patient.middle_name"
                   type="text">
        </div>
        <div class="form-group">
            <label for="patient.sex">Gender:</label>
            <select class="form-control" id="patient.sex" name="patient.sex">
                <option value="">...</option>
                <option value="M">Male</option>
                <option value="F">Female</option>
            </select>
        </div>

        <div class="form-group">
            <label for="patient.birth_date">Date Of Birth:</label>
            <input class="form-control" id="patient.birth_date" name="patient.birth_date"
                   type="text"
            >
        </div>

    </div>
    <div class="section">
        <h3>Medical History</h3>

        <div class="form-group">
            <label for="encounter.location_id">Patient's complaint(s):<span
                    class="required">*</span></label>
            <input class="form-control valid-location-only" id="encounter.location_id" type="text"
                   placeholder="Start typing something..." required="required">
            <input class="form-control" name="encounter.location_id" type="hidden">
        </div>

        <div class="form-group">
            <label for="encounter.location_id">Present Medical History:<span
                    class="required">*</span></label>
            <input class="form-control valid-location-only" id="encounter.location_id" type="text"
                   placeholder="Start typing something..." required="required">
            <input class="form-control" name="encounter.location_id" type="hidden">
        </div>

        <div class="form-group">
            <label for="encounter.location_id">Past Medical History:<span class="required">*</span></label>
            <input class="form-control valid-location-only" id="encounter.location_id" type="text"
                   placeholder="Start typing something..." required="required">
            <input class="form-control" name="encounter.location_id" type="hidden">
        </div>
        <div class="form-group">
            <input class="form-control" id="encounter.form_uuid" name="encounter.form_uuid"
                   type="hidden"
                   required="required">
        </div>
    </div>


    <div class="section">
        <h3>Physical Examination</h3>

        <div class="form-group">
            <label for="systolic_blood_pressure">
                Systolic blood pressure (mmHg):<span class="required">*</span>
            </label>
            <input class="form-control systolicBloodPressure" id="systolic_blood_pressure"
                   name="systolic_blood_pressure" type="number"
                   placeholder="Please record today's SBP"
                   data-concept="5085^SYSTOLIC BLOOD PRESSURE^99DCT"
                   required="required">
        </div>
        <div class="form-group">
            <label for="diastolic_blood_pressure">
                Diastolic blood pressure (mmHg):<span class="required">*</span>
            </label>
            <input class="form-control diastolicBloodPressure lessThanSystolic"
                   id="diastolic_blood_pressure"
                   name="diastolic_blood_pressure" type="number"
                   placeholder="Please record today's DBP"
                   data-concept="5086^DIASTOLIC BLOOD PRESSURE^99DCT"
                   required="required">
        </div>
        <div class="form-group">
            <label for="pulse">Pulse rate (per minute):<span class="required">*</span></label>
            <input class="form-control" id="pulse" name="pulse" type="number"
                   placeholder="Please record today's pulse" required="required"
                   data-concept="5087^PULSE^99DCT">
        </div>
        <div class="form-group">
            <label for="pulse">Respiratory rate:<span class="required">*</span></label>
            <input class="form-control" id="respiratory_rate" name="respiratory_rate" type="number"
                   placeholder="Please record today's respiratory rate" required="required"
                   data-concept="5242^RESPIRATORY RATE^99DCT">
        </div>
        <div class="form-group">
            <label for="temperature_c">Temperature (centigrade):<span
                    class="required">*</span></label>
            <input class="form-control" id="temperature_c" name="temperature_c" type="number"
                   placeholder="Please record today's temperature" required="required"
                   data-concept="5088^TEMPERATURE (C)^99DCT">
        </div>
        <div class="form-group">
            <label for="weight_kg">Weight (kg):<span class="required">*</span></label>
            <input class="form-control" id="weight_kg" name="weight_kg" type="number"
                   placeholder="Please record today's weight" required="required"
                   data-concept="5089^WEIGHT (KG)^99DCT">
        </div>
        <div class="form-group">
            <label for="height_cm">Height (cm):<span class="required">*</span></label>
            <input class="form-control" id="height_cm" name="height_cm" type="number"
                   placeholder="Please record today's height" required="required"
                   data-concept="5090^HEIGHT (CM)^99DCT">
        </div>

        <div class="section">
            <div class="form-group">
                <label for="body_surface_area">Body surface area (m^2)</label>
                <input class="form-control" id="body_surface_area" name="body_surface_area"
                       type="number"

                       data-concept="980^BODY SURFACE AREA^99DCT">
            </div>
        </div>
    </div>


    <div class="section">
        <div class="form-group">
            <label for="encounter.provider_id_select">Community Health Worker Name:</label>
            <input class="form-control valid-provider-only" id="encounter.provider_id_select"
                   type="text"
                   placeholder="Start typing provider name here ...">
            <input class="form-control" name="encounter.provider_id_select" type="hidden">
        </div>
        <div class="form-group hidden">
            <select id="select_providers">
                <option data-provider="Daurine Achieng Agumba" value="3419-9">Daurine Achieng
                    Agumba
                </option>
                <option data-provider="Irene Chepkosgei	Kurgat" value="3420-7">Irene Chepkosgei
                    Kurgat
                </option>
                <option data-provider="Rose	Cheruto	Toroitich" value="3421-5">Rose Cheruto
                    Toroitich
                </option>

            </select>
        </div>

        <div class="form-group show_provider_id_text">
            <label for="encounter.provider_id">Enter CHV system-id:<span
                    class="required">*</span></label>
            <input class="form-control checkDigit" id="encounter.provider_id"
                   name="encounter.provider_id" type="text"
                   required="required">
        </div>

        <div class="form-group">
            <label for="return_visit_date">Return visit date:</label>
            <input class="form-control datepicker checkFutureDate future-date"
                   data-concept="5096^RETURN VISIT DATE^99DCT"
                   id="return_visit_date" name="return_visit_date" type="text">
        </div>
    </div>

</form>
</body>
<script type="text/javascript">

$(document).ready(function () {

    var dateFormat = "dd-mm-yy";
    var currentDate = $.datepicker.formatDate(dateFormat, new Date());
    var encounterDatetime = $('#encounter\\.encounter_datetime');
    if ($(encounterDatetime).val() == "") {
        $(encounterDatetime).val(currentDate);
    }

    $('#save_draft').click(function () {
          AppJavascriptInterface.saveCHVForm();
    });

    $('#submit_form').click(function () {
        AppJavascriptInterface.saveCHVForm();
    });

    $('#breastcancer_form').validate({
        rules: {
            pulse: {
                number: true,
                range: [0, 230]
            },
            temperature_c: {
                number: true,
                range: [25, 43]
            },
            weight_kg: {
                number: true,
                range: [0, 250]
            },
            height_cm: {
                number: true,
                range: [10, 228]
            },
            age_of_menarche: {
                number: true,
                range: [8, 23]
            },
            gravida: {
                digits: true,
                min: 0,
                max: 50
            },
            parity: {
                digits: true,
                min: 0,
                max: 50
            },
            age_of_first_pregnancy: {
                digits: true,
                range: [8, 50]
            },
            respiratory_rate: {
                digits: true,
                range: [10,30]
            },
            mass_measurement_in_cm_second_direction: {
                number: true,
                range: [2,10]
            },
            mass_measurement_in_cm_first_direction: {
                number: true,
                range: [2,10]
            }
        }
    });

    var locationName = [
        {"val": "7", "label": "Chulaimbo"},
        {"val": "3", "label": "Turbo"},
        {"val": "17", "label": "Iten"},
        {"val": "2", "label": "Mosoriot"},
        {"val": "8", "label": "Webuye"},
        {"val": "84", "label": "Ampath MTRH"}
    ];

    document.setupAutoCompleteData('encounter\\.location_id');

    document.setupAutoCompleteDataForProvider('encounter\\.provider_id_select');

    $('#encounter\\.provider_id_select').change(function () {
        if ($('#encounter\\.provider_id_select').val() === '') {
            $('#encounter\\.provider_id').val('');
            $('.show_provider_id_text').show();
        }
    });

    /* Start - Checking that the diastolic blood pressure is less than the systolic blood pressure */
    $.validator.addMethod("lessThanSystolic", function (value, element) {
                if ($.fn.isNotRequiredAndEmpty(value, element)) return true;
                var systolicBloodPressure = parseInt($(element).closest('.section').find('.systolicBloodPressure').val());
                return (parseInt(value) <= systolicBloodPressure);
            }, "DBP cannot be more than SBP."
    );

    // attach 'lessThanSystolic' class to perform validation.
    jQuery.validator.addClassRules({
        lessThanSystolic: { lessThanSystolic: true }
    });
    /* End - lessThanSystolic*/

    /* Start - Checking that parity is less than gravida */
    $.validator.addMethod("lessThanGravida", function (value, element) {
                if ($.fn.isNotRequiredAndEmpty(value, element)) return true;
                var gravida = parseInt($(element).closest('.section').find('.gravida').val());
                return (parseInt(value) <= gravida);
            }, "Number of deliveries can't be more than number of pregnancies."
    );

    // attach 'lessThanGravida' class to perform validation.
    jQuery.validator.addClassRules({
        lessThanGravida: { lessThanGravida: true }
    });
    /* End - lessThanGravida*/

    /* Start - Female only breast cancer history */
        var $patientSex = $('#patient\\.sex');
        $patientSex.change(function () {
            var $womenOnly = $('.relevant-female');
            if ($patientSex.val() != 'F') {
                $womenOnly.hide();
            } else {
                $womenOnly.show();
            }
        });
        $patientSex.trigger('change');
        /* End - Female only breast cancer history */

    /* Start - Toggle for gravida and parity based on gravida value */
    var $parity = $('#parity');
    var $gravida = $('#gravida');
    $gravida.change(function () {
        var gravidaValue = parseInt($gravida.val());
        var $parityRelevant = $('.relevant_parity');
        var $gravidaRelevant = $('.relevant_gravida');
        if (gravidaValue > 0) {
            $gravidaRelevant.show();
            $parity.trigger('change');
        } else {
            $parityRelevant.hide();
            $gravidaRelevant.hide();
        }
    });
    $gravida.trigger('change');

    $parity.change(function () {
        var parityValue = parseInt($parity.val());
        var $parityRelevant = $('.relevant_parity');
        if (parityValue > 0) {
            $parityRelevant.show();
        } else {
            $parityRelevant.hide();
        }
    });
    $parity.trigger('change');
    /* End - Toggle for gravida and parity based on gravida value */

    /* Start - Checks that a field is a decimal */
    $.validator.addClassRules({
        systolicBloodPressure: {
            number: true,
            range: [50, 300]
        },
        diastolicBloodPressure: {
            number: true,
            range: [20, 150]
        }
    });
    /* End - Checks that a field is a decimal */

    document.disableAdd = function (answerToQuestion, sectionFromWhichAddShouldBeDisabled) {

        var $answerToTheQuestion = $('#'+ answerToQuestion);
        $answerToTheQuestion.change(function () {
        var answerToTheQuestionValue = $answerToTheQuestion.val();
        var $sectionFromWhichAddButtonShouldBeRemoved = $('#' + sectionFromWhichAddShouldBeDisabled);
        if (answerToTheQuestionValue == '1118^NOT DONE^99DCT') {
            $sectionFromWhichAddButtonShouldBeRemoved.find('.add_section').remove();
            $sectionFromWhichAddButtonShouldBeRemoved.find('.remove_section').remove();
        }
    });
    $answerToTheQuestion.trigger('change');

    }
    document.disableAdd('skin_exam_findings','skin_exam_findings_detailed');
    document.disableAdd('breast_exam_findings','breast_exam_findings_detailed');

    /* Start - Toggle family illness detailed */
    var $familyHistory = $('#family_chronic_illnesses_history');
    $familyHistory.change(function () {
        var $relevantFamilyHistory = $('.relevant_family_chronic_illnesses_history');
        if ($familyHistory.val() == '6544^BREAST CANCER^99DCT') {
            $relevantFamilyHistory.show();
        } else {
            $relevantFamilyHistory.hide();
        }
    });
    $familyHistory.trigger('change');
    /* End - Toggle family illness detailed */

    /*  Start - Based on breast review show duration fields */
    var breastReviewChange = function (selectedElement) {
        var breastDuration = {
            "#review_of_systems_breast\\.breast_pain": ".breast_pain_duration",
            "#review_of_systems_breast\\.mastitis": ".breast_inflammation_duration",
            "#review_of_systems_breast\\.breast_lumps": ".breast_mass_duration",
            "#review_of_systems_breast\\.nipple_discharge": ".nipple_discharge_duration",
            "#review_of_systems_breast\\.breast_skin_changes": ".breast_skin_changes_duration"
        };
        $.each(breastDuration, function (k, v) {
            $(k).change(function () {
                if ($(k).is(':checked')) {
                    $(v).show();
                } else {
                    $(v).hide();
                }
            });
            $(k).trigger('change');
        });
    };
    breastReviewChange();
    /*  End - Based on breast review show duration fields */

    /* Start - Remove temporary information */
    $.fn.removeTemporaryData = function (idList) {
        $.each(idList, function (i, id) {
            var $element = $('#' + id);
            var elementValue = $element.val();
            if (elementValue == "with-temp.NO") {
                $element.removeAttr('data-concept');
            }
        });
        return true;
    };
    /* End - Remove temporary information */

    var referralValues = ['1107^NONE^99DCT'];
    var referralMessage = "If None is selected, it should be the only option.";
    $(':checkbox[data-concept="1272^REFERRALS ORDERED^99DCT"]').change(function () {
        showValidationMessages(validateAlone($(this), referralValues, referralMessage));
    });

    var familyPlanningValues = ['1624^DO NOT KNOW^99DCT', '1107^NONE^99DCT'];
    var familyPlanningMessage = "If None or Don't know is selected, it should be the only option.";
    $(':checkbox[data-concept="8253^FAMILY PLANNING METHOD EVER USED^99DCT"]').change(function () {
        showValidationMessages(validateAlone($(this), familyPlanningValues, familyPlanningMessage));
    });

    var breastReviewValues = ['664^NEGATIVE^99DCT'];
    var breastReviewMessage = "If No Complaints is selected, it should be the only option.";
    $(':checkbox[data-concept="6492^REVIEW OF SYSTEMS - BREAST^99DCT"]').change(function () {
        showValidationMessages(validateAlone($(this), breastReviewValues, breastReviewMessage));
    });

    var lymphNodeValues = ['1118^NOT DONE^99DCT', '1115^NORMAL^99DCT', '161^LYMPHADENOPATHY^99DCT'];
    var lymphNodeMessage = "If Normal, Not Done or Generalized lympadenopathy is selected, it should be the only option.";
    $(':checkbox[data-concept="1121^LYMPH NODE EXAM FINDINGS^99DCT"]').change(function () {
        showValidationMessages(validateAlone($(this), lymphNodeValues, lymphNodeMessage));
    });

    var idList = ['diagnosis_based_on_biopsy', 'history_of_surgeries', 'previous_radiation_location',
        'review_of_medical_history', 'family_chronic_illnesses_history'];

    $.fn.customValidationCheck = function () {
        var referral = $('fieldset[name="1272^REFERRALS ORDERED^99DCT"]');
        var lymphNode = $('fieldset[name="1121^LYMPH NODE EXAM FINDINGS^99DCT"]');
        var breastReview = $('fieldset[name="6492^REVIEW OF SYSTEMS - BREAST^99DCT"]');
        var familyPlanning = $('fieldset[name="8253^FAMILY PLANNING METHOD EVER USED^99DCT"]');
        var communication = $('fieldset[name="8250^COMMUNICATION CHANNEL OF KNOWING THE PROGRAM OR SERVICE^99DCT"]');
        var familyHistory = $('fieldset[name="8254^FAMILY MEMBER WITH CHRONIC ILLNESSES HISTORY^99DCT"]');
        var referredReason = $('fieldset[name="2327^REASONS FOR REFERRAL^99DCT"]');
        var errors = $.extend({},
                validateSelected(referral),
                validateSelected(lymphNode),
                validateSelected(breastReview),
                validateSelected(familyPlanning),
                validateSelected(communication),
                validateSelected(familyHistory),
                validateSelected(referredReason),
                validateAlone(referral, referralValues, referralMessage),
                validateAlone(lymphNode, lymphNodeValues, lymphNodeMessage),
                validateAlone(familyPlanning, familyPlanningValues, familyPlanningMessage),
                validateAlone(breastReview, breastReviewValues, breastReviewMessage));
        showValidationMessages(errors);
        return $.fn.removeTemporaryData(idList) && $.isEmptyObject(errors);
    };
    /* End - Example of calling above validation */

    /* Start - Breast exam findings */
    var breastExamFindingDetailed = function (selectedElement) {
        var allBreastExamFindings = $("select[name='breast_exam_findings']");
        $.each(allBreastExamFindings, function (index, object) {
            $(object).change(function () {
                var breastExamValue = $(this).val();
                var $breastExamFindingsRelevant = $(this).closest('.section').find('.relevant_breast_exam_findings');
                if (breastExamValue === '' || breastExamValue == '1118^NOT DONE^99DCT' || breastExamValue == '1115^NORMAL^99DCT') {
                    $breastExamFindingsRelevant.hide();
                } else {
                    $breastExamFindingsRelevant.show();
                }
            });
            $(object).trigger('change');
        });
    };
    breastExamFindingDetailed();
    /* End - Breast exam findings */

    /* Start - Disable adding section if not done is selected */
    // TODO: Need to add validation to prevent "NOT DONE" being selected when there are multiple repeat
    // Create something similar to the systole!
    // Get all select element and check if there's value that should be selected alone
    // Return message like the systole
    /* End - Disable adding section if not done is selected */

    /* Start - Skin exam findings */
    var skinExamFindingsDetailed = function (selectedElement) {
        var allSkinExamFindings = $("select[name='skin_exam_findings']");
        $.each(allSkinExamFindings, function (index, object) {
            $(object).change(function () {
                var skinExamValue = $(this).val();
                var $skinExamFindingsRelevant = $(this).closest('.section').find('.relevant_skin_exam_findings');
                var $skinExamFindingsRelevantMass = $(this).closest('.section').find('.relevant_skin_exam_findings_mass');
                if (skinExamValue == '582^MASS, OTHER^99DCT') {
                    $skinExamFindingsRelevant.show();
                    $skinExamFindingsRelevantMass.show();
                } else if (skinExamValue == '8188^CALOR^99DCT') {
                    $skinExamFindingsRelevant.show();
                    $skinExamFindingsRelevantMass.hide();
                } else {
                    $skinExamFindingsRelevant.hide();
                    $skinExamFindingsRelevantMass.hide();
                }
            });
            $(object).trigger('change');
        });
    };
    skinExamFindingsDetailed();
    /* End - Skin exam findings */

    /* Start - Disable adding section if not done is selected */
    // TODO: Need to add validation to prevent "NOT DONE" being selected when there are multiple repeat
    // Create something similar to the systole!
    // Get all select element and check if there's value that should be selected alone
    // Return message like the systole
    /* End - Disable adding section if not done is selected */

    /* Start - Referral NONE */
    var referred = $("input[data-concept='1272^REFERRALS ORDERED^99DCT']");
    var referredNone = referred.filter("[value='1107^NONE^99DCT']");
    var referredOther = referred.not("[value='1107^NONE^99DCT']");
    // affected element
    var referredRelevant = $('.relevant_referral_ordered');
    referredNone.change(function () {
        if ($(this).is(':checked')) {
            referredRelevant.hide();
        } else {
            if (referredOther.filter(":checked").length > 0) {
                referredRelevant.show();
            }
        }
    });
    referredNone.trigger("change");

    referredOther.change(function () {
        if (referredNone.filter(":checked").length <= 0
                && referredOther.filter(":checked").length > 0) {
            referredRelevant.show();
        } else {
            referredRelevant.hide();
        }
    });
    referredOther.trigger("change");
    /* End - Referral NONE */

    /* Start - BSA calculation */
    // we will bind this process to the change of weight and height
    var $weight = $("#weight_kg");
    var $height = $("#height_cm");
    var $bodySurface = $('#body_surface_area');
    $weight.change(function () {
        var weightValue = parseFloat($weight.val());
        var heightValue = parseFloat($height.val());
        if (weightValue !== 'NaN' && heightValue !== 'NaN') {
            var value = Math.sqrt((weightValue * heightValue) / 3600);
            $bodySurface.val(value);
        }
    });
    $weight.trigger("change");
    $height.change(function () {
        var weightValue = parseFloat($weight.val());
        var heightValue = parseFloat($height.val());
        if (weightValue !== 'NaN' && heightValue !== 'NaN') {
            var value = Math.sqrt((weightValue * heightValue) / 3600);
            $bodySurface.val(value);
        }
    });
    $height.trigger("change");
    /* End - BSA calculation */


    document.setupValidationForProvider("$('#encounter\\.provider_id_select').val()","encounter\\.provider_id");

    document.setupValidationForLocation("$('#encounter\\.location_id').val()","encounter\\.location_id");

});

</script>
</html>
